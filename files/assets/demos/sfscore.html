  <!DOCTYPE html>

  <html>
  <meta charset="utf-8">
  
  <head>

  <script src="/assets/scripts/jquery-1.12.2.min.js"></script>
  <script src= "/assets//scripts/d3.v3.min.js" > </script>
  <script src= "/assets//scripts/d3.tip.min.js" > </script> 
  <style type="text/css">
  body {
    font: 11px sans-serif;
    margin: 10px;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .bar:hover {
    fill: #259359 ;
  }

  .x.axis path {
    display: none; 
  }

  #vis{
      text-align:center;
  }

  #sfscore{
    text-align:center;
    font-size: 1.5em;
    padding-bottom: 1em;
  }

  .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #efefef;
      border-radius: 2px;
  }

</style>
  </head>

  <body>
  <p id="sfscore"></p>
  <div id="vis"></div>
  <script type="text/javascript">
  var margin = {
    top: 224,
    right: 100,
    bottom: 120,
    left: 20
  },
width = 450 - margin.left - margin.right,
height = 350 - margin.top - margin.bottom;

var formatScore = d3.format(".0%");

var colours = ["#FFB363", "#FF8363", "#FF7363", "#FF6364"];
var color =d3.scale.ordinal().range(colours);
//var color = d3.scale.category10();

var parseDate = d3.time.format("%Y%m%d").parse;
var formatDate = d3.time.format("%b %d %Y");
var formatTitle = d3.time.format("%b %d %Y");

  <!-- Thanks to Gerardo Furtado for kind support. -->
// Scales. Note the inverted domain fo y-scale: bigger is up!
var y = d3.scale.linear()
    .range([height, 0]);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(formatScore);

var tip = d3.tip()
    .attr('class', 'd3-tip')
    .offset([-10, 0])
    .html(function(d) {
      return "<strong>" + "SF Score: " + "</strong><span style='color:#fff'>" + d.score + "</span>";
    })
// csv loaded asynchronously
d3.tsv("sfscore.tsv", type, function(data) {

  // Data is nested by course
  var courses = d3.nest()
      .key(function(d) {
        return d.course;
      })
  //      .key(function(d) { return d.date;})
      .entries(data);
  var dates = d3.nest()
      .key(function(d) {
        return d.date;
      })
  //      .key(function(d) { return d.date;})
      .entries(data);
  var score = d3.nest()
      .key(function(d) {
        return d.score;
      })
  //      .key(function(d) { return d.date;})
      .entries(data);

  var sum = d3.sum(data, function(d) { return d.score; });
  

  var xScale = {};

  courses.forEach(function(d) {
    xScale[d.key] = d3.scale.ordinal()
      .rangeRoundBands([0, width], .1)
      .domain(d.values.map(function(e) {
        return e.date
      }));
  });

  // Parse dates and numbers. We assume values are sorted by date.
  // Also compute the maximum price per symbol, needed for the y-domain.
  //   s.maxPrice = d3.max(s.values, function(d) { return d.price; });
  // });

  // Compute the minimum and maximum date and score across symbols.
  y.domain([0, d3.max(courses, function(s) {
    return s.values[0].score;
  })]);

  var xAxis = d3.svg.axis()
      .orient("bottom");

  // Add an SVG element for each course, with the desired dimensions and margin.
  var svg = d3.select("#vis").selectAll("svg")
      .data(courses)
      .enter()
      .append("svg:svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .each(function(d) {
      return d3.select(this).call(xAxis.scale(xScale[d.key]))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", "-.55em")
        .attr("transform", "rotate(-90)");
    })


      svg.append("g")
  // Hide y axis
  // .attr("class", "y axis")
  // .call(yAxis)
    .append("text")
    .attr("x", width / 2 + margin.left / 2 + margin.right / 4 )
    .attr("y", 0.9 * margin.bottom)
    .attr("dy", ".71em")
    .style("font-weight", "bold")
    .attr("text-anchor", "end")
    .attr("font-size", "1.1em")
    .text(function(d) {
      return d.key
    });

  // Accessing nested data: https://groups.google.com/forum/#!topic/d3-js/kummm9mS4EA
  // data(function(d) {return d.values;}) 
  // this will dereference the values for nested data for each group
  svg.selectAll(".bar")
    .data(function(d) {
      return d.values;
    })
    .enter()
    .append("rect")
    .attr("class", "bar")
    .attr("x", function(d) {
      var scale = d3.select(this.parentNode).datum().key;
      return xScale[scale](d.date);
    })
    .attr("width", function() {
      var scale = d3.select(this.parentNode).datum().key;
      return xScale[scale].rangeBand()
    })
    .attr("y", function(d) {
      return y(d.score);
    })
    .attr("height", function(d) {
      return height - y(d.score);
    })
    .attr("fill", function(d) {
      return color(d.score)
    })
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);

  svg.call(tip);
  document.getElementById('sfscore').innerHTML = "Total SF Score" +": <strong>" + sum.toString() +"</strong>";

});

function type(d) {
  d.score = +d.score;
  d.date = formatDate(parseDate(d.date));
  return d;
}

</script>
  </body>
  </html>
